#!/bin/bash

# Default to 1 if no parameter is given
count=${1-1}

# Max of 20 machines only, change accordingly
max=20

# Check if the count parameter is a positive integer within the allowed range
if ! [[ $count =~ ^[0-9]+$ ]] || ! [[ "$count" -gt 0 && "$count" -le "$max" ]]; then
    echo "[ERROR] Parameter is not a positive integer (must be between 1 and $max)." >&2
    exit 1
fi

if [ "$count" -gt "$max" ]; then
    count=$max
fi

# Initialize environment variables
source ./app_do.env

# Initialize iterator and IP list
iterator=1
server_ips=""

while [ "$iterator" -le "$count" ]; do
    echo "Provisioning machine for JMeter Worker node $iterator..."

    # Create the DigitalOcean droplet for the JMeter worker
    docker-machine create \
        --driver digitalocean \
        --digitalocean-access-token "$DIGITALOCEAN_ACCESS_TOKEN" \
        --digitalocean-region "$DIGITALOCEAN_REGION" \
        --digitalocean-size "$DIGITALOCEAN_SIZE" \
        --digitalocean-image "ubuntu-20-04-x64" \
        --engine-label type=worker \
        jmeter-worker-$iterator

    if [ $? -ne 0 ]; then
        echo "[ERROR] Failed to create the JMeter Worker machine: jmeter-worker-$iterator."
        exit 1
    fi

#**Non-Interactive System Update**
echo "Updating the Ubuntu system on jmeter-controller without interactive prompts..."
docker-machine ssh jmeter-controller "sudo DEBIAN_FRONTEND=noninteractive apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -y"

    # Add a delay to allow the Droplet to finish initializing
    echo "Waiting 60 seconds for the Droplet to fully initialize..."
    sleep 60

     # Retry SSH connection with a loop to handle potential delays (Newly Added)
    for i in {1..5}; do
        if docker-machine ssh jmeter-worker-$iterator "echo 'SSH connection successful'"; then
            break
        else
            echo "Retrying SSH connection to jmeter-worker-$iterator in 10 seconds..."
            sleep 10
        fi
    done

    # Set the environment variables to point to the newly created machine
    eval "$(docker-machine env jmeter-worker-$iterator)"

    # Add another delay to ensure SSH setup is ready
    echo "Waiting 30 seconds to ensure SSH is available on the new Droplet..."
    sleep 30

    # **Add firewall rules to open necessary ports for Docker Swarm and JMeter communication** (Newly Added)
    docker-machine ssh jmeter-worker-$iterator "sudo ufw allow 2377/tcp"
    docker-machine ssh jmeter-worker-$iterator "sudo ufw allow 7946/tcp"
    docker-machine ssh jmeter-worker-$iterator "sudo ufw allow 7946/udp"
    docker-machine ssh jmeter-worker-$iterator "sudo ufw allow 4789/udp"
    docker-machine ssh jmeter-worker-$iterator "sudo ufw allow 1099/tcp"
    docker-machine ssh jmeter-controller "sudo ufw --force enable"

    echo "Firewall rules configured to allow necessary ports for Docker Swarm and JMeter."

    # Get the public IP address of the worker node
    ip=$(docker-machine ip jmeter-worker-$iterator)

    echo "Running JMeter in Server Mode on jmeter-worker-$iterator with IP: $ip..."

   # Run the JMeter server using the updated Docker image and attach it to the overlay network (Modified)
    docker run \
        --detach \
        --publish 1099:1099 \
        --network jmeter-network \  # Ensures that the worker joins the same Docker overlay network
        --env IP=$ip \
        justb4/jmeter

    # Concatenate worker IP addresses
    server_ips+="$ip,"

    # Increment the iterator
    iterator=$((iterator + 1))
done

# Output the list of worker IP addresses for use by the JMeter Controller node
echo "Worker IPs for use in JMeter Controller: $(echo $server_ips | sed 's/,$//')"

exit
